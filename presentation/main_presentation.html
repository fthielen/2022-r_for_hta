<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Estimating Dutch costs of productivity losses in R using up-to-date data from Statistics Netherlands (CBS) with the R-package cbsodataR    AND    Copy and paste code, not output. Writing technical reports of any economic analysis in R with Bookdown</title>
    <meta charset="utf-8" />
    <meta name="author" content="Frederick Thielen" />
    <meta name="date" content="2022-05-23" />
    <script src="libs/header-attrs-2.13/header-attrs.js"></script>
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/default-fonts.css" rel="stylesheet" />
    <script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
    <link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
    <script src="libs/datatables-binding-0.22/datatables.js"></script>
    <script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
    <link href="libs/dt-core-1.11.3/css/jquery.dataTables.min.css" rel="stylesheet" />
    <link href="libs/dt-core-1.11.3/css/jquery.dataTables.extra.css" rel="stylesheet" />
    <script src="libs/dt-core-1.11.3/js/jquery.dataTables.min.js"></script>
    <link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet" />
    <script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script>
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

.title[
# Estimating Dutch costs of productivity losses in R using up-to-date data from Statistics Netherlands (CBS) with the R-package cbsodataR <br><br> AND <br><br> Copy and paste code, not output. Writing technical reports of any economic analysis in R with Bookdown
]
.author[
### Frederick Thielen
]
.date[
### 23 May 2022
]

---


name: hello
class: middle, center, inverse




&lt;style type="text/css"&gt;
.pre {
  height: 30pc;
  overflow-y: scroll;
}
&lt;/style&gt;



### Frederick Thielen, Ph.D.

&lt;img style="border-radius: 50%;" src="https://github.com/fthielen.png" width="150px"/&gt;

### Assistant professor

### Erasmus School of Health Policy and Management (Rotterdam, The Netherlands)

[<svg aria-hidden="true" role="img" viewBox="0 0 496 512" style="height:1em;width:0.97em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> @fthielen](https://github.com/fthielen)    
[<svg aria-hidden="true" role="img" viewBox="0 0 512 512" style="height:1em;width:1em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg> @apreshill](https://twitter.com/fwthielen)   
[<svg aria-hidden="true" role="img" viewBox="0 0 512 512" style="height:1em;width:1em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg> data-fred.com](https://www.data-fred.com)

Slide(s) inspired by [Alison Hill](https://github.com/apreshill/talks/blob/main/agu-panel/index.Rmd)

---
class: middle, center
# Hello *R for HTA* world

&lt;img src="../images/me.jpg" width="85%" /&gt;

---

# Material

All material presented here can be found on github:

[**github.com/fthielen/2022-r_for_hta**](https://github.com/fthielen/2022-r_for_hta)



---

class: middle, center, inverse
background-image: url(https://images.unsplash.com/photo-1652959894563-e815de31350e?crop=entropy&amp;cs=tinysrgb&amp;fm=jpg&amp;ixlib=rb-1.2.1&amp;q=80&amp;raw_url=true&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=2070)

# Estimating Dutch costs of productivity losses in R using up-to-date data from Statistics Netherlands (CBS) with the R-package cbsodataR

.footnote[Picture taken from Pawel Czerwinski on [unsplash.com](https://unsplash.com/@pawel_czerwinski)]
---
class: middle
background-image: url(https://cdn-icons-png.flaticon.com/512/1946/1946042.png)
background-position: 95% 5%
background-size: 5%

# Productivity losses

+ When people become sick, they sometime cannot work any more due to the illness

--

+ Required for most economic evaluations from a societal perspective (like in NL)

--

+ Estimation starts with identifying where and when health-related productivity changes occur [Krol &amp; Brouwer 2014](https://pubmed.ncbi.nlm.nih.gov/24504850/)

--

+ The Dutch guideline to conduct economic evaluations in healthcare
[Dutch EE guideline](https://www.zorginstituutnederland.nl/publicaties/publicatie/2016/02/29/richtlijn-voor-het-uitvoeren-van-economische-evaluaties-in-de-gezondheidszorg) recommends the friction cost method

.footnote[This and all other icons in this presentation are taken from flaticon.com]
---
class: middle
# Example: productivity losses (paid work)

Methodology to calculate the friction period is explained in the Dutch EE guideline:




$$ Friction period = \frac{365}{(\frac{V_f}{V_o})} + 28 $$

--

With:
- `\(V_f\)` = Vacancies filled
- `\(V_o\)` = Vacancies open

---

# Method

- is fixed

- relies on data from Statistics Netherlands (CBS)

--

- Estimates in the Dutch EE guideline are mentioned but old: reference year is 2014 (85 days = 12.1 wks)

- is only the first step to determine productivity losses:

   - at least productivity prices are needed

   - maybe female/male ratio important

   - maybe percentage working per age group needed
   
   - productivity losses for unpaid work may be relevant

--

**The friction period and all other elements need to be re-calculated for the year of the analysis!**

---
class: middle
background-image: url(https://cdn-icons-png.flaticon.com/512/1046/1046277.png)
background-position: 95% 5%
background-size: 5%

# The "classic" approach?

One possibility is to:

- download CBS data

- perform calculation (maybe using some old Excel formulas from another project)?

--

A downside:

- time consuming

- probably much copy/paste from downloaded data

- what if projects takes long(er) than expected and updates are necessary?

---
class: middle
background-image: url(https://cdn-icons.flaticon.com/png/512/2930/premium/2930685.png?token=exp=1653257651~hmac=86e5b1b22d351a6337c9ef823e891f1b
background-position: 95% 5%
background-size: 5%

# The Rpproach

Another possibility is to:

- standardise the standard approach (write a function)

- automatically download CBS data from CBS servers

- only keep what you need

- build in flexibility (e.g., updates when needed)

--

How to:

- use existing packages

- write a function

- use it

---

# R packages from national statistics bureaus

- The Netherlands: **cbsodataR**

- Canada: **cansim**, **StatCanR**

- Germany: **wiesbaden**

- ...

---
background-image: url(https://cdn-icons-png.flaticon.com/512/1534/1534999.png)
background-position: 95% 50%
background-size: 25%

# Example: calculating the friction period for the Netherlands

Several steps:

1. Identify needed data source

--

2. Download data
  - Not every time code runs (save time)
  - Build in flexibility (possible updates, re-use of code)

--

3. Do calculations

--

4. Put everything in a function

--

5. Use &amp; re-use

---

# Step 1: data sources

All data can be found and searched on the CBS website or via Google:

- each data source has a specific identifier

--

Example: numer of job vacancies since 2008

- https://www.cbs.nl/nl-nl/cijfers/detail/80472ned

Identifier is: 80472ned

---

# Step 1: data sources

Available data can also be browsed through a catalogue retrievable in the R package.

Also refer to the package site on [github](https://github.com/edwindj/cbsodataR)


```r
# Load package (do not forget to install first)
library("cbsodataR")

res &lt;- cbsodataR::cbs_search(query = "vacature")
```

---
# Step 1: data sources


```r
res[, c("Identifier", "Title")] %&gt;% 
        dt_p
```

<div id="htmlwidget-76a11a58c94e04ed318a" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-76a11a58c94e04ed318a">{"x":{"filter":"none","vertical":false,"fillContainer":false,"data":[["1","2","3","4","5","6","7","8","9","10"],["80474ned","80472ned","84166NED","84164NED","84545NED","80473ned","83599NED","80567ned","85081NED","80857ned"],["Vacatures; seizoengecorrigeerd, SBI2008","Vacatures; SBI 2008; naar economische activiteit en bedrijfsgrootte","Arbeidsvolume; bedrijfstak, kwartalen, nationale rekeningen","Arbeidsvolume; bedrijfstak, geslacht, nationale rekeningen","Vacatures; stroomcijfers, seizoengecorrigeerd","Vacatures;SBI2008;particuliere bedrijven","Openstaande vacatures; SBI 2008, regio","Vacatures; vacaturegraad naar SBI 2008","Ontstane vacatures; beroepenindeling ROA-CBS 2014 (BRC 2014), SBI 2008","Vacatures (openstaande, ontstane en vervulde); overheid en onderwijs"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>Identifier<\/th>\n      <th>Title<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"scrollCollapse":true,"columnDefs":[{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script>

---

# Step 2: Download data

Download with function `cbs_get_data()` (from cbsodataR package):


```r
df_vacancy &lt;- cbsodataR::cbs_get_data("80472ned") 
```

--

Downside:

- downloads every time code runs
  - is time (and energy) consuming
  
- probably not needed since updates are not that frequent (yearly)

---

# Download, store and update (when necessary)

- define a folder where CBS data should be stored (recommendation: "CBS" in "raw")

--

- integrate the year in the file name

- store as `.RDS` file


```r
dir_path &lt;- paste0("raw/CBS/")

dir_path
```

```
## [1] "raw/CBS/"
```

```r
file_name &lt;- paste0(
        lubridate::year(Sys.Date()),
        "-raw_friction_period.RDS")

file_name
```

```
## [1] "2022-raw_friction_period.RDS"
```

---

# Download, store and update (when necessary)

- create the directory when needed?


```r
if (!dir.exists(here::here(dir_path))) dir.create(here::here(dir_path),
                                                             recursive = TRUE)
```

--


```r
saveRDS(object = df_vacancy, file = here::here(paste0(dir_path, "/", file_name)))
```

---

# Write first part of function
.pre[

```r
f_cbs_friction_period &lt;- function(
                folder_name = "raw/CBS",
                file_name = "-raw_friction_period.RDS",
                force_download = FALSE
){
        # Required libraries ----
        require("here")
        require("cbsodataR")
        require("lubridate")
        
        # Download and update ----
        dir_path &lt;- folder_name
        file_path &lt;- paste0(
                lubridate::year(Sys.Date()),
                file_name)
        full_path &lt;- paste0(dir_path, "/", file_path)
        
         # Create directory if not existing
        if (!dir.exists(here::here(dir_path))) 
                dir.create(here::here(dir_path),
                                      recursive = TRUE)

        # Download data
        if (force_download | !file.exists(here::here(full_path))) {
                df_vacancy &lt;- cbsodataR::cbs_get_data("80472ned")
                saveRDS(df_vacancy, file = here::here(full_path))
                } else {
                        df_vacancy &lt;- readRDS(here::here(full_path))
                }
        
*       df_vacancy &lt;&lt;- df_vacancy
}
```
]
---

# Step 3: calculations

## First: inspect data

.pre[

```r
head(df_vacancy)
```

```
## # A tibble: 6 × 5
##   Bedrijfskenmerken Perioden OpenstaandeVacat… OntstaneVacatur… VervuldeVacatur…
##   &lt;chr&gt;             &lt;chr&gt;                &lt;dbl&gt;            &lt;dbl&gt;            &lt;dbl&gt;
## 1 T001081           1997KW01              89.8             152.             142 
## 2 T001081           1997KW02             102.              190.             178.
## 3 T001081           1997KW03              92.7             183.             192.
## 4 T001081           1997KW04             116.              189.             166.
## 5 T001081           1997JJ00              NA               715              679 
## 6 T001081           1998KW01             134.              220.             202.
```
]
---

# Step 3: calculations

- some variables are "cryptic"

- dates are not stored as date/time variables

---
# Step 3: calculations

- `cbsodataR::cbs_add_label_columns()` and `cbsodataR::cbs_add_date_column()` can fix this

.pre[

```r
df_vacancy %&gt;% 
      cbsodataR::cbs_add_label_columns() %&gt;% 
        cbsodataR::cbs_add_date_column() %&gt;% 
        head()
```

```
## # A tibble: 6 × 9
##   Bedrijfskenmerken Bedrijfskenmerken_label Perioden Perioden_Date Perioden_freq
##   &lt;chr&gt;             &lt;fct&gt;                   &lt;chr&gt;    &lt;date&gt;        &lt;fct&gt;        
## 1 T001081           A-U Alle economische a… 1997KW01 1997-01-01    Q            
## 2 T001081           A-U Alle economische a… 1997KW02 1997-04-01    Q            
## 3 T001081           A-U Alle economische a… 1997KW03 1997-07-01    Q            
## 4 T001081           A-U Alle economische a… 1997KW04 1997-10-01    Q            
## 5 T001081           A-U Alle economische a… 1997JJ00 1997-01-01    Y            
## 6 T001081           A-U Alle economische a… 1998KW01 1998-01-01    Q            
## # … with 4 more variables: Perioden_label &lt;fct&gt;, OpenstaandeVacatures_1 &lt;dbl&gt;,
## #   OntstaneVacatures_2 &lt;dbl&gt;, VervuldeVacatures_3 &lt;dbl&gt;
```
]

---
# Step 3: calculations

## What data are relevant?

- interested in yearly average = `Perioden_freq` == `Y`

- several industry sectors available:

---


```r
df_vacancy %&gt;% 
      cbsodataR::cbs_add_label_columns() %&gt;% 
        cbsodataR::cbs_add_date_column() %&gt;% 
        distinct(Bedrijfskenmerken, Bedrijfskenmerken_label) %&gt;% 
        dt_p()
```

<div id="htmlwidget-7576bdb95c7103167606" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-7576bdb95c7103167606">{"x":{"filter":"none","vertical":false,"fillContainer":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58"],["T001081","301000 ","305700 ","300002 ","300003 ","307500 ","307610 ","328105 ","339205 ","300023 ","346600 ","348000 ","350000 ","354200 ","300006 ","300007 ","354300 ","356900 ","371600 ","371700 ","372200 ","383100 ","383200 ","386800 ","388400 ","389100 ","391600 ","391705 ","396300 ","396400 ","398700 ","400200 ","402000 ","300010 ","403300 ","403405 ","406800 ","408105 ","410200 ","413200 ","415000 ","417400 ","419000 ","419200 ","419700 ","420700 ","422400 ","300013 ","300012 ","422600 ","425300 ","426600 ","428100 ","435500 ","300014 ","WP19074","WP19091","WP19098"],["A-U Alle economische activiteiten","A Landbouw, bosbouw en visserij","B Delfstoffenwinning","B-E Nijverheid (geen bouw) en energie","B-F Nijverheid en energie","C Industrie","10-12 Voedings-, genotmiddelenindustrie","24-25 Basismetaal, metaalprod.-industrie","29-30 Transportmiddelenindustrie","31-33 Overige industrie en reparatie","D Energievoorziening","E Waterbedrijven en afvalbeheer","F Bouwnijverheid","G Handel","G-I Handel, vervoer en horeca","G-N Commerciële dienstverlening","45 Autohandel en -reparatie","46 Groothandel en handelsbemiddeling","47 Detailhandel (niet in auto’s)","471 Supermarkten en warenhuizen","472 Winkels in voedingsmiddelen","H Vervoer en opslag","49 Vervoer over land","52 Opslag, dienstverlening voor vervoer","53 Post en koeriers","I Horeca","J Informatie en communicatie","58-60 Uitgeverijen, film,radio en t.v.","K Financiële dienstverlening","64 Bankwezen","65 Verzekeraars en pensioenfondsen","66 Overige financiële dienstverlening","L Verhuur en handel van onroerend goed","M-N Zakelijke dienstverlening","M Specialistische zakelijke diensten","69-71 Management- en technisch advies","72 Research","73-75 Reclame, design, overige diensten","N Verhuur en overige zakelijke diensten","78201 Uitzendbureaus","81 Schoonmaakbedrijven, hoveniers e.d.","O Openbaar bestuur en overheidsdiensten","P Onderwijs","852 Basisonderwijs en speciaal onderwijs","853 Voortgezet onderwijs","854 Hoger onderwijs","Q Gezondheids- en welzijnszorg","O-U Niet-commerciële dienstverlening","O-Q Overheid en zorg","861 Ziekenhuizen","87 Verpleging en zorg met overnachting","88 Welzijnszorg zonder overnachting","R Cultuur, sport en recreatie","S Overige dienstverlening","R-U Cultuur, recreatie, overige diensten","Bedrijfsgrootte: 0 tot 10 werkzame pe...","Bedrijfsgrootte: 10 tot 100 werkzame ...","Bedrijfsgrootte: 100 of meer werkzame..."]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>Bedrijfskenmerken<\/th>\n      <th>Bedrijfskenmerken_label<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"scrollCollapse":true,"columnDefs":[{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script>

---
## Filter and calculate


```r
df_vacancy %&gt;% 
        cbsodataR::cbs_add_label_columns() %&gt;% 
        cbsodataR::cbs_add_date_column() %&gt;% 
        filter(Perioden_freq == "Y",
               Bedrijfskenmerken %in% c("T001081")) %&gt;%
        mutate(Year = lubridate::year(Perioden_Date),
               Friction_period_days = 362 /
                       (VervuldeVacatures_3 /
                                OpenstaandeVacatures_1) +
                       28,
               Friction_period_wks = Friction_period_days / 7) %&gt;% 
        distinct(Year,
                 VervuldeVacatures_3,
                 OpenstaandeVacatures_1,
                 Friction_period_days,
                 Friction_period_wks) %&gt;%
        rename(Filled_vacancies = "VervuldeVacatures_3",
               Open_vacancies = "OpenstaandeVacatures_1")
```

---
## Filter and calculate

<div id="htmlwidget-a01efcdc3c229ce03df2" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-a01efcdc3c229ce03df2">{"x":{"filter":"none","vertical":false,"fillContainer":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25"],[null,136,172,203.7,198.4,150.4,110,118.8,150.2,206.3,240,240.4,143.4,121.6,132.5,111.5,95.1,108.2,129.7,155.9,200.6,248.3,281.1,221.3,313.4],[679,834,904,997,989,781,672,697,830,988,1105,1088,794,737,774,679,624,689,800,887,999,1146,1232,1085,1244],[1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2020,2021],[null,87.03,96.88,101.96,100.62,97.71,87.26,89.7,93.51,103.59,106.62,107.99,93.38,87.73,89.97,87.44,83.17,84.85,86.69,91.63,100.69,106.43,110.6,101.83,119.2],[null,12.43,13.84,14.57,14.37,13.96,12.47,12.81,13.36,14.8,15.23,15.43,13.34,12.53,12.85,12.49,11.88,12.12,12.38,13.09,14.38,15.2,15.8,14.55,17.03]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>Open_vacancies<\/th>\n      <th>Filled_vacancies<\/th>\n      <th>Year<\/th>\n      <th>Friction_period_days<\/th>\n      <th>Friction_period_wks<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"scrollCollapse":true,"columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script>

---

# Step 4: put everything in a function

## Define some function arguments:

- `years`: Year(s) of interest

- `industry`: most likely "all", but define for flexibility

- `folder_name`: set a standard, but define for flexibility

- `file_name`: set a standard, but define for flexibility

- `force_download`: jsut to be sure

- `yearsdays`: 365 in formula but most often 365.25

---
.pre[

```r
f_cbs_friction_period &lt;- function(
                years,
                industry = "T001081",        
                folder_name = "raw/CBS",
                file_name = "-raw_friction_period.RDS",
                force_download = FALSE,
                yeardays = 365){
        
        # Required libraries ----
        require("here")
        require("cbsodataR")
        require("lubridate")
        
        # Download and update ----
        dir_path &lt;- folder_name
        file_path &lt;- paste0(
                lubridate::year(Sys.Date()),
                file_name)
        full_path &lt;- paste0(dir_path, "/", file_path)
        
        # Create directory if not existing
        if (!dir.exists(here::here(dir_path))) 
                dir.create(here::here(dir_path),
                           recursive = TRUE)
        
        # Download data
        if (force_download | !file.exists(here::here(full_path))) {
                df_vacancy &lt;- cbsodataR::cbs_get_data("80472ned")
                saveRDS(df_vacancy, file = here::here(full_path))
        } else {
                df_vacancy &lt;- readRDS(here::here(full_path))
        }
        
        # Calculate ----
        df_vacancy %&gt;% 
                cbsodataR::cbs_add_label_columns() %&gt;% 
                cbsodataR::cbs_add_date_column() %&gt;% 
                filter(Perioden_freq == "Y",
                       Bedrijfskenmerken %in% industry) %&gt;% 
                mutate(
                        Year = lubridate::year(Perioden_Date),
                        Friction_period_days = yeardays /
                                (VervuldeVacatures_3 / OpenstaandeVacatures_1) +
                                28,
                        Friction_period_wks = Friction_period_days / 7) %&gt;% 
                distinct(
                        Year,
                        VervuldeVacatures_3,
                        OpenstaandeVacatures_1,
                        Friction_period_days,
                        Friction_period_wks
                ) %&gt;%
                rename(Filled_vacancies = "VervuldeVacatures_3",
                       Open_vacancies = "OpenstaandeVacatures_1") %&gt;% 
                filter(Year %in% years)
        
}
```
]

---

# Step 5: Use &amp; re-use


```r
df_friction &lt;- f_cbs_friction_period(years = 2011:2021)

df_friction %&gt;%
        dt_p
```

<div id="htmlwidget-ca285e19fd331b278df1" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-ca285e19fd331b278df1">{"x":{"filter":"none","vertical":false,"fillContainer":false,"data":[["1","2","3","4","5","6","7","8","9","10","11"],[132.5,111.5,95.1,108.2,129.7,155.9,200.6,248.3,281.1,221.3,313.4],[774,679,624,689,800,887,999,1146,1232,1085,1244],[2011,2012,2013,2014,2015,2016,2017,2018,2019,2020,2021],[90.483850129199,87.9374079528719,83.6274038461538,85.3193033381713,87.175625,92.1527621195039,101.292292292292,107.083333333333,111.280438311688,102.446543778802,119.954180064309],[12.9262643041713,12.5624868504103,11.946771978022,12.188471905453,12.4536607142857,13.1646803027863,14.4703274703275,15.297619047619,15.8972054730983,14.6352205398288,17.1363114377584]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>Open_vacancies<\/th>\n      <th>Filled_vacancies<\/th>\n      <th>Year<\/th>\n      <th>Friction_period_days<\/th>\n      <th>Friction_period_wks<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"scrollCollapse":true,"columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script>

---

# Sidestep: plot


```r
ggplot(data = df_friction, aes(x = Year, y = Friction_period_wks)) +
        geom_point() +
        theme_light()
```

![](main_presentation_files/figure-html/unnamed-chunk-8-1.png)&lt;!-- --&gt;

---

# And now?

- friction period = maximum days to account for productivity losses

- In 2021: 120 days

- Productivity costs per hour: 34.75 Euro (2014, average female/male, Dutch EE guideline [see Table 6.2])

  - same price still used in many publications
  
  - should be indexed with consumer price index (CPI, table ID: "83131NED") or with price
  index work (table ID: "84183NED")?

---

# Example

Keeping all other variables the same as in the Dutch EE guideline example (Example 9):

- Person with 3 days of work

- 8 hours per day

- 34.75 Euro per hour

--


```r
# Note: the results fetched from CBS are 12.2 weeks due to rounding
prod_loss14 &lt;- round(12.1 * 3 * 8 * 34.75, 2) 

prod_loss21 &lt;- round(
        df_friction$Friction_period_wks[
                df_friction$Year == 2021] * 3 * 8 * 34.75, 2)
```

- In 2014: 10091.4 Euro

- In 2021: 14291.68 Euro


---
class: middle
background-image: url(https://cdn-icons-png.flaticon.com/512/5247/5247524.png)
background-position: 95% 5%
background-size: 5%

# Take home message

- **cbsodataR** is a powerful package do download data from CBS

- downloading all data every time can be time consuming

- writing you own function for this task makes the approach verifyable and re-usable

- Not covered: putting these function in your own *package* makes it even more flexible

--

Estimating costs of productivity losses

- can be fun

- but we need to consider more than just resource use (proportion female/male, unpaid work etc.)

---
class: middle, center, inverse
background-image: url(https://images.unsplash.com/photo-1651870364199-fc5f9f46ac85?ixlib=rb-1.2.1&amp;raw_url=true&amp;q=80&amp;fm=jpg&amp;crop=entropy&amp;cs=tinysrgb&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=1470)

# Writing technical reports in R with **bookdown**

.footnote[Picture taken from Pawel Czerwinski on [unsplash.com](https://unsplash.com/@pawel_czerwinski)]
---

+ Aim: get you started with bookdown without knowing much about the technicalities

--

+ Approach: trial and (lots of) error = personal view

--

+ Downside: high level of frustration, things can take a while, high level of happiness if it works

---
background-image: url(https://cdn-icons-png.flaticon.com/512/627/627495.png)
background-position: 95% 50%
background-size: 25%
# What you need

- R

- R Studio

- Some knowledge of (R)Markdown

- Zotero, if you want to add references

---

# Why bookdown and not only (R)markdown?

Advantages over (R)markdown - to me

- Demands more structure (chapter sequences)

- Automatic cross-referencing of Figures

- Automatic cross-referencing of Tables

- Render a HTML to share and include a PDF file to download

- Many different styles available that are customisable

---

# How to bookdown?

- most comprehensive guide: [*bookdown: Authoring Books and Technical Documents with R Markdown*](https://bookdown.org/yihui/bookdown/)

--

- after installation of package **bookdown**: File &gt; New Project... &gt; New directory &gt; Book project using bookdown

  - great for first steps
  - creates quite some files you probably don't need
  
---

# What is covered in this presentation?

- brief overview of most important files needed to *bookdown*

--

- proposal for folder structure

--

- some basics for your YAML (including `_bookdown.yml`) and `preamble.tex`

--

- printing nice tables (flexible for PDF and HTML output)

--

- adding citations with Zotero

---
background-image: url(https://cdn-icons-png.flaticon.com/512/1534/1534999.png)
background-position: 95% 50%
background-size: 25%

# Steps in creating your project with bookdown

1. Folder structure to keep overview

--

2. Set-up your citations (both literature and R-packages)

--

3. Tweak your `_bookdown.yml` and `preamble.tex`

--

4. Write (code and text)

--

5. Render

---

# Step 1: folder structure

## Proposed folder structure:


```
##               levelName
## 1  rprojecthome        
## 2   ¦--_book           
## 3   ¦--raw             
## 4   ¦--data            
## 5   ¦--images          
## 6   ¦--scripts         
## 7   ¦   ¦--R           
## 8   ¦   °--Rmd         
## 9   °--references      
## 10      ¦--zotero.bib  
## 11      ¦--packages.bib
## 12      °--nature.csl
```

---

# What do these folders contain?

- `_book`: automatically generated by **bookdown** and will contain the PDF or HTML book

- `raw`: some raw data needed for the project

- `data`: clean/[tidy](https://r4ds.had.co.nz/tidy-data.html) data

- `images`: all images/figure/charts/graphs exported from your project (not for your report)

- `scripts`: all R or RMarkdown scripts (or other) needed for the analysis

- `references`: literature and package references (HOW TO? covered in this presentation)

---

# Step 2: set-up citations (references)

- works best with [Zotero](https://www.zotero.org)

- needs extension **Better BibTeX (BBT)**

--

**BBT:**

- generates "Citation Keys", needed to refer to citation in `.Rmd`

  - Citation Keys can be customised: Zotero &gt; Preferences &gt; Better BibTex

--

- makes it easy to export "live" `.bib` files

  - Right click library &gt; Export Library... &gt; Format "Better BibTeX &gt; Select: "Keep updated"
  
  - Choose Rproject &gt; references

---

# Step 2: set-up citations (R-packages)

- after loading the packages:


```r
knitr::write_bib(file = here::here("references/packages.bib"))
```

- generates a `.bib` file with package references in specified folder

---

# Step 2: set-up citations (styles)

- citation style based on CSL (Citation Style Language)

- best to use [Zotero Style Repository](https://www.zotero.org/styles) to search and download `.csl` file

--

- put `.csl` file in you Rproject folder **references**

- more information in the [R Markdown Cookbook](https://bookdown.org/yihui/rmarkdown-cookbook/bibliography.html#changing-citation-style)

---

# Step 3: tweak your YAML

- "meta-data" of your book

- contains information on

  - Author(s)
  
  - Date
  
  - How *Table of Contents* looks like (i.e., how many levels are shown)
  
  - Font sizes
  
  - "Geometry" of document
  
  - Citations and citation styles

--

- Can be extensive

- Information can be (partly) stored in `_bookdown.yml`

- Understands "R" but does not always work for me (e.g., using **here**)

---

# Step 3: tweak your YAML

- needs to be at very start of document (i.e., first `.Rmd` that will be rendered)

- important to keep (explained later):

&lt;img src="../images/yml_must1.jpg" width="652" /&gt;

---

# Step 3: tweak your YAML (_bookdown.yml)

In `_bookdown.yml`:

- specify document name: `book_filename:`

- determine sequence of `.Rmd` files to be rendered: `rmd_files:`

---

# Step 3: tweak your preamble.tex

- More specific LaTeX code lives here

- LaTeX works with packages (like R)

--

- Important/useful not standard packages:

  - **longtable** for tables over several pages
  
  - **lastpage** to count pages numbers as e.g., 1 of 29
  
  - **lscape** for easy landscape pages
  
  - **float** to keep figures in place
  
  - **fancyhdr** for document headers
  
- activation of packages with `\usepackage{longtable}`

---

# Step 4: write your report

## Start writing you analyses and report in /Rmd folder

- A typical report contains multiple chapters

- Start with creating one .Rmd per chapter and use distinct names

- Finish with one chapter for the references

--

- Recommendation:

  - `# Preface {-}`
  - `# Introduction`
  - `# Chapter 1`
  - `...`
  - `# Chapter n`
  - `# References`

---
# Some lessons I have learned

- Do not use `_` to name chunks, use `-` instead

- Restart R-session before your compile/render your report.
  - I often get an error if I don't: "! Undefined control sequence. &lt;recently read&gt; \cellcolor"


---

# Usefull resources and further reading

- [Meet boodkown](https://arm.rbind.io/slides/bookdown.html#1)

- [Reproducible Science for Busy Researchers: How to Save Time using Literate Programming](https://bookdown.org/alapo/learnr/)

- [Introduction to bookdown (video)](https://www.rstudio.com/resources/webinars/introducing-bookdown/)

- [A minimal book example](https://benmarwick.github.io/bookdown-ort/) and especially the "Open Review" section

- [rstudio4edu](https://rstudio4edu.github.io/rstudio4edu-book/index.html)
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLanguage": ["r", "css", "yaml"],
"highlightLines": true,
"countIncrementalSlides": false,
"ratio": "16:9"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
