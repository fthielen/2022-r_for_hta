# Post-processing of Model Outputs

## Summary of Results

Once the model has been run, we can use the results and summarize them using the `summary_results_det` to print the results of the last simulation (if nsim=1, itâ€™s the deterministic case), and `summary_results_psa` to show the PSA results (with the confidence intervals). We can also use the individual patient data generated by the simulation, which we collect here to plot in the `psa_ipd` object.


The last simulation is summarised in Table \@ref(tab:last-sim), and the results of
the PSA are summarised in Table \@ref(tab:res-psa).

```{r last-sim}
summary_results_det(results$final_output) %>% 
        tibble::rownames_to_column("item") %>% 
        fkbl(caption = "Last simulation results",
             col.names = c("Item", "Intervention", "No intervention")) %>% 
        fkbl_style()
```

```{r res-psa}
summary_results_psa(results$output_psa) %>% 
        tibble::rownames_to_column("item") %>% 
        fkbl(caption = "PSA results",
             col.names = c("Item", "Intervention", "No intervention")) %>% 
        fkbl_style()
```

Finally, the Table with the first ten rows of the simulation of the original
tutorial is summarised in Table \@ref(tab:last-tab) (with the original column
names).

```{r last-tab}
psa_ipd <- bind_rows(map(results$output_psa, "merged_df")) 

psa_ipd[1:10,] %>%
        fkbl(caption = "Last table") %>% 
        fkbl_style(scale = TRUE)
```

## Plots

We now use the data output to plot the histograms/densities of the simulation.

With **bookdown**, Plots and Figures can also be cross-referenced. Be aware that
for those, the caption needs to be provided in the R-code chunk through
`fig.cap` (see chunk below in the `.Rmd` file). In-text, Figures are referenced
similar to Tables. Figure \@ref(fig:plot1) summarises the event times.

```{r plot1, fig.cap="First Figure"}
data_plot <- results$final_output$merged_df %>%
  filter(evtname != "sick") %>%
  group_by(trt,evtname,simulation) %>%
  mutate(median = median(evttime)) %>%
  ungroup()

ggplot(data_plot) +
  geom_density(aes(fill = trt, x = evttime),
               alpha = 0.7) +
  geom_vline(aes(xintercept=median,col=trt)) +
  facet_wrap( ~ evtname, scales = "free") +
  scale_y_continuous(expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  theme_bw()
```

We can also plot the patient level incremental QALY/costs. Note that there are several clusters in the distribution of patients according to their QALY/costs based on the pathway they took (early metastatic vs. remission and cure or recurrence, see Figure \@ref(fig:plot2)).

```{r plot2, fig.cap="Last Figure of Tutorial"}
data_qaly_cost<- psa_ipd[,.SD[1],by=.(pat_id,trt,simulation)][,.(trt,qaly=total_qalys,cost=total_costs,pat_id,simulation)]
data_qaly_cost[,ps_id:=paste(pat_id,simulation,sep="_")]


mean_data_qaly_cost <- data_qaly_cost %>% group_by(trt) %>% summarise(across(where(is.numeric),mean))

ggplot(data_qaly_cost,aes(x=qaly, y = cost, col = trt)) + 
  geom_point(alpha=0.15,shape = 21) +
  geom_point(data=mean_data_qaly_cost, aes(x=qaly, y = cost, fill = trt), shape = 21,col="black",size=3) +
  scale_y_continuous(expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = .5))
```

You can also cross-reference and link to previous chapter like so: see
Section \@ref(intro) for a short introduction to this tutorial.